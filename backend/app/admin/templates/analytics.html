{% extends "layout.html" %}

{% block content %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>

<style>

        /* ============================================
           –î–∞—à–±–æ—Ä–¥ ‚Äî –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
           ============================================ */
        .analytics-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
            margin-bottom: 2rem;
        }
        .analytics-header h1 {
            font-weight: 700;
            color: #fff;
            margin: 0;
            font-size: 1.6rem;
        }
        .analytics-header p {
            color: #666;
            margin: 4px 0 0 0;
            font-size: 0.9rem;
        }

        /* –§–∏–ª—å—Ç—Ä –¥–∞—Ç */
        .date-filter {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .date-filter label {
            color: #888;
            font-size: 0.85rem;
            font-weight: 500;
        }
        .date-filter input[type="date"] {
            background: #1a1a1a;
            border: 1px solid #333;
            color: #fff;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.85rem;
            outline: none;
            font-family: inherit;
        }
        .date-filter input[type="date"]:focus {
            border-color: var(--accent-green);
            box-shadow: 0 0 0 2px rgba(0,255,128,0.15);
        }
        .btn-apply {
            background: var(--accent-green);
            color: #000;
            border: none;
            padding: 8px 20px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }
        .btn-apply:hover {
            background: #00cc66;
            box-shadow: 0 4px 12px rgba(0,255,128,0.3);
        }
        .btn-reset {
            background: transparent;
            color: #aaa;
            border: 1px solid #333;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 500;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }
        .btn-reset:hover {
            border-color: #666;
            color: #fff;
            background: rgba(255,255,255,0.05);
        }

        /* –°–µ—Ç–∫–∞ –±–ª–æ–∫–æ–≤ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        /* –ö–∞—Ä—Ç–æ—á–∫–∞ */
        .stat-card {
            background: linear-gradient(145deg, #121212, #0d0d0d);
            border: 1px solid #222;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            position: relative;
            overflow: hidden;
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 3px;
            background: linear-gradient(90deg, #00ff80, #4dabf7);
            opacity: 0.6;
        }
        .stat-card h3 {
            color: #fff;
            font-size: 1rem;
            font-weight: 600;
            margin: 0 0 6px 0;
        }
        .stat-card .card-subtitle {
            color: #666;
            font-size: 0.8rem;
            margin-bottom: 16px;
        }
        .stat-card.full-width { grid-column: 1 / -1; }

        /* –ú–∏–Ω–∏-—Å—Ç–∞—Ç—ã */
        .mini-stats {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .mini-stat {
            display: flex;
            flex-direction: column;
            background: rgba(255,255,255,0.03);
            padding: 12px 18px;
            border-radius: 10px;
            border: 1px solid #1a1a1a;
            min-width: 100px;
        }
        .mini-stat .value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--accent-green);
            line-height: 1;
        }
        .mini-stat .label {
            font-size: 0.75rem;
            color: #888;
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .mini-stat.accent-blue .value { color: var(--accent-blue); }
        .mini-stat.accent-yellow .value { color: var(--accent-yellow); }
        .mini-stat.accent-red .value { color: var(--accent-red); }
        .mini-stat.accent-purple .value { color: var(--accent-purple); }

        /* Canvas –≥—Ä–∞—Ñ–∏–∫–æ–≤ */
        .chart-container {
            position: relative;
            width: 100%;
            max-height: 300px;
        }

        /* –ö–Ω–æ–ø–∫–∞ "–ø–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ" */
        .btn-expand {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(0,255,128,0.08);
            color: var(--accent-green);
            border: 1px solid rgba(0,255,128,0.2);
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.82rem;
            font-weight: 500;
            cursor: pointer;
            margin-top: 16px;
            transition: all 0.2s;
            font-family: inherit;
        }
        .btn-expand:hover {
            background: rgba(0,255,128,0.15);
            border-color: var(--accent-green);
        }

        /* –¢–∞–±–ª–∏—Ü–∞ –≤—Å–µ—Ö –æ—Ç–≤–µ—Ç–æ–≤ */
        .all-answers-table {
            display: none;
            margin-top: 16px;
            max-height: 400px;
            overflow-y: auto;
        }
        .all-answers-table.open { display: block; }
        .all-answers-table table { width: 100%; border-collapse: collapse; }
        .all-answers-table th {
            text-align: left;
            color: #888;
            font-size: 0.75rem;
            text-transform: uppercase;
            padding: 8px 12px;
            border-bottom: 1px solid #222;
            position: sticky;
            top: 0;
            background: #121212;
        }
        .all-answers-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #1a1a1a;
            color: #ccc;
            font-size: 0.88rem;
        }
        .all-answers-table tr:hover td { background: rgba(0,255,128,0.03); }
        .all-answers-table .bar-cell { width: 120px; }
        .mini-bar {
            height: 6px;
            background: var(--accent-green);
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        /* –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å ‚Äî –∑–∞–≥–ª—É—à–∫–∞ */
        .feedback-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 180px;
            color: #555;
            text-align: center;
        }
        .feedback-placeholder i {
            font-size: 2.5rem;
            margin-bottom: 12px;
            color: #333;
        }
        .feedback-placeholder p { margin: 0; font-size: 0.9rem; }
        .badge-soon {
            display: inline-block;
            background: rgba(167,139,250,0.15);
            color: var(--accent-purple);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 10px;
        }

        /* –í–æ—Ä–æ–Ω–∫–∞ */
        .funnel-list { list-style: none; padding: 0; margin: 0; }
        .funnel-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid #1a1a1a;
        }
        .funnel-item:last-child { border-bottom: none; }
        .funnel-bar-wrap {
            flex: 1;
            height: 8px;
            background: #1a1a1a;
            border-radius: 4px;
            overflow: hidden;
        }
        .funnel-bar {
            height: 100%;
            border-radius: 4px;
            background: linear-gradient(90deg, #00ff80, #4dabf7);
            transition: width 0.6s ease;
        }
        .funnel-label {
            flex: 0 0 40%;
            color: #bbb;
            font-size: 0.85rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .funnel-count {
            flex: 0 0 50px;
            text-align: right;
            color: var(--accent-green);
            font-weight: 600;
            font-size: 0.9rem;
        }

        /* –ù–∞–∑–∞–¥ */
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: #888;
            font-size: 0.85rem;
            margin-bottom: 10px;
            text-decoration: none;
        }
        .back-link:hover { color: var(--accent-green); }

        /* –°—Ç–∞—Ç—É—Å—ã */
        .status-row { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 12px; }
        .status-chip {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(255,255,255,0.04);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.8rem;
            color: #aaa;
        }
        .status-chip .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
        .dot-completed { background: var(--accent-green); }
        .dot-in-progress { background: var(--accent-yellow); }
        .dot-abandoned { background: var(--accent-red); }

        /* –ó–∞–≥—Ä—É–∑–∫–∞ */
        .loading-overlay {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 60px;
            color: #555;
            font-size: 0.9rem;
            gap: 10px;
        }
        .spinner {
            width: 20px; height: 20px;
            border: 2px solid #333;
            border-top-color: var(--accent-green);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        @media (max-width: 768px) {
            .stats-grid { grid-template-columns: 1fr; }
            .funnel-label { flex: 0 0 35%; }
        }
</style>

<!-- Analytics Page Content -->
<a href="/admin" class="back-link">
    <i class="fa-solid fa-arrow-left"></i> –ù–∞–∑–∞–¥ –∫ –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
</a>

        <div class="analytics-header">
            <div>
                <h1>üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –æ–ø—Ä–æ—Å–æ–≤</h1>
                <p>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–π –∏ –ø–æ–≤–µ–¥–µ–Ω–∏—è –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤</p>
            </div>
            <form class="date-filter" id="dateFilterForm">
                <label>–û—Ç</label>
                <input type="text" name="date_from" id="dateFrom" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É..." readonly>
                <label>–î–æ</label>
                <input type="text" name="date_to" id="dateTo" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É..." readonly>
                <button type="submit" class="btn-apply">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                <button type="button" class="btn-reset" id="btnReset" title="–°–±—Ä–æ—Å–∏—Ç—å –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω—é—é –Ω–µ–¥–µ–ª—é">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</button>
            </form>
        </div>

        <!-- –ú–∏–Ω–∏-—Å—Ç–∞—Ç—ã -->
        <div class="mini-stats" id="miniStats">
            <div class="mini-stat">
                <span class="value" id="totalCompleted">‚Äî</span>
                <span class="label">–ó–∞–≤–µ—Ä—à–µ–Ω–æ (–ø–µ—Ä–∏–æ–¥)</span>
            </div>
            <div class="mini-stat accent-blue">
                <span class="value" id="todayCount">‚Äî</span>
                <span class="label">–°–µ–≥–æ–¥–Ω—è</span>
            </div>
            <div class="mini-stat accent-purple">
                <span class="value" id="avgTime">‚Äî</span>
                <span class="label">–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è (–º–∏–Ω)</span>
            </div>
        </div>

        <!-- –†—è–¥ —Å—Ç–∞—Ç—É—Å–æ–≤ -->
        <div class="status-row" id="statusRow"></div>

        <!-- –ó–∞–≥—Ä—É–∑–∫–∞ -->
        <div class="loading-overlay" id="loadingOverlay">
            <div class="spinner"></div>
            –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...
        </div>

        <!-- –ë–ª–æ–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
        <div class="stats-grid" id="statsGrid" style="display:none;">

            <!-- –ë–õ–û–ö 1: –ì—Ä–∞—Ñ–∏–∫ –æ–ø—Ä–æ—Å–æ–≤ -->
            <div class="stat-card full-width">
                <h3>üìà –î–∏–Ω–∞–º–∏–∫–∞ –ø—Ä–æ–π–¥–µ–Ω–Ω—ã—Ö –æ–ø—Ä–æ—Å–æ–≤</h3>
                <div class="card-subtitle">–ß–∏—Å–ª–æ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –æ–ø—Ä–æ—Å–æ–≤ –ø–æ –¥–Ω—è–º</div>
                <div class="chart-container">
                    <canvas id="completedChart"></canvas>
                </div>
            </div>

            <!-- –ë–õ–û–ö 2: –¢–æ–ø-10 –æ—Ç–≤–µ—Ç–æ–≤ -->
            <div class="stat-card full-width">
                <h3>üèÜ –ß–∞—Å—Ç–æ—Ç–∞ –≤—ã–±–æ—Ä–∞ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–æ–≤</h3>
                <div class="card-subtitle">–¢–æ–ø-10 —Å–∞–º—ã—Ö –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤</div>
                <div class="chart-container" style="max-height:400px;">
                    <canvas id="topAnswersChart"></canvas>
                </div>
                <button class="btn-expand" id="btnExpandAnswers" onclick="toggleAllAnswers()">
                    <i class="fa-solid fa-expand"></i> –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –æ—Ç–≤–µ—Ç—ã
                </button>
                <div class="all-answers-table" id="allAnswersTable">
                    <table>
                        <thead>
                            <tr><th>#</th><th>–í–æ–ø—Ä–æ—Å ‚Üí –û—Ç–≤–µ—Ç</th><th>–ö–æ–ª-–≤–æ</th><th class="bar-cell"></th></tr>
                        </thead>
                        <tbody id="allAnswersBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- –ë–õ–û–ö 3: –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å (–∑–∞–≥–ª—É—à–∫–∞) -->
            <div class="stat-card">
                <h3>üí¨ –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å</h3>
                <div class="card-subtitle">–û—Ç–∑—ã–≤—ã –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤ –æ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–∏</div>
                <div class="feedback-placeholder">
                    <i class="fa-solid fa-comment-dots"></i>
                    <p>–ó–¥–µ—Å—å –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è<br>–æ—Ç–∑—ã–≤—ã –∏ –æ—Ü–µ–Ω–∫–∏ –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤</p>
                    <span class="badge-soon">–°–∫–æ—Ä–æ</span>
                </div>
            </div>

            <!-- –ë–õ–û–ö 4: –í–æ—Ä–æ–Ω–∫–∞ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è -->
            <div class="stat-card">
                <h3>üîª –í–æ—Ä–æ–Ω–∫–∞ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è</h3>
                <div class="card-subtitle">–ù–∞ –∫–∞–∫–æ–º –≤–æ–ø—Ä–æ—Å–µ –ø–∞—Ü–∏–µ–Ω—Ç—ã –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è</div>
                <ul class="funnel-list" id="funnelList">
                    <li class="funnel-item" style="color:#555;">–ó–∞–≥—Ä—É–∑–∫–∞...</li>
                </ul>
            </div>

        </div>

<script>
    // ============================================
    // –ó–∞–≥—Ä—É–∑–∫–∞ –∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –¥–∞—à–±–æ—Ä–¥–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
    // ============================================

    var completedChartInstance = null;
    var topAnswersChartInstance = null;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞—Ç –∏–∑ URL
    (function initDates() {
        var params = new URLSearchParams(window.location.search);
        var df = params.get('date_from');
        var dt = params.get('date_to');
        if (df) document.getElementById('dateFrom').value = df;
        if (dt) document.getElementById('dateTo').value = dt;
    })();

    // –§–æ—Ä–º–∞ —Ñ–∏–ª—å—Ç—Ä–∞
    document.getElementById('dateFilterForm').addEventListener('submit', function(e) {
        e.preventDefault();
        var from = document.getElementById('dateFrom').value;
        var to = document.getElementById('dateTo').value;
        var url = '/admin/analytics';
        var params = [];
        if (from) params.push('date_from=' + from);
        if (to) params.push('date_to=' + to);
        if (params.length) url += '?' + params.join('&');
        window.location.href = url;
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å API
    async function loadDashboard() {
        var params = new URLSearchParams(window.location.search);
        var apiUrl = '/api/v1/analytics/dashboard';
        if (params.toString()) apiUrl += '?' + params.toString();

        try {
            var resp = await fetch(apiUrl);
            if (!resp.ok) throw new Error('HTTP ' + resp.status);
            var data = await resp.json();

            document.getElementById('loadingOverlay').style.display = 'none';
            document.getElementById('statsGrid').style.display = '';
            renderDashboard(data);
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏:', err);
            document.getElementById('loadingOverlay').innerHTML =
                '<span style="color:#ff6b6b;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É.</span>';
        }
    }

    function renderDashboard(data) {
        // –ú–∏–Ω–∏-—Å—Ç–∞—Ç—ã
        document.getElementById('totalCompleted').textContent = data.chart.total;
        document.getElementById('todayCount').textContent = data.chart.today;
        document.getElementById('avgTime').textContent = data.chart.avg_minutes || '‚Äî';

        // –°—Ç–∞—Ç—É—Å—ã
        var statusRow = document.getElementById('statusRow');
        var statusLabels = {
            'completed': ['–ó–∞–≤–µ—Ä—à—ë–Ω', 'dot-completed'],
            'in_progress': ['–í –ø—Ä–æ—Ü–µ—Å—Å–µ', 'dot-in-progress'],
            'abandoned': ['–ë—Ä–æ—à–µ–Ω', 'dot-abandoned'],
        };
        statusRow.innerHTML = '';
        for (var key in statusLabels) {
            var label = statusLabels[key][0];
            var cls = statusLabels[key][1];
            var cnt = (data.statuses && data.statuses[key]) || 0;
            statusRow.innerHTML += '<div class="status-chip"><span class="dot ' + cls + '"></span>' + label + ': <strong>' + cnt + '</strong></div>';
        }

        renderCompletedChart(data.chart.labels, data.chart.values);
        renderTopAnswersChart(data.top_answers);
        renderAllAnswersTable(data.all_answers);
        renderFunnel(data.funnel);
    }

    function renderCompletedChart(labels, values) {
        var ctx = document.getElementById('completedChart').getContext('2d');
        if (completedChartInstance) completedChartInstance.destroy();

        completedChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: '–ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –æ–ø—Ä–æ—Å—ã',
                    data: values,
                    borderColor: '#00ff80',
                    backgroundColor: 'rgba(0,255,128,0.08)',
                    fill: true,
                    tension: 0.35,
                    pointRadius: 5,
                    pointBackgroundColor: '#00ff80',
                    pointBorderColor: '#0d0d0d',
                    pointBorderWidth: 2,
                    pointHoverRadius: 7,
                    borderWidth: 2.5,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: '#1a1a1a',
                        titleColor: '#fff',
                        bodyColor: '#00ff80',
                        borderColor: '#333',
                        borderWidth: 1,
                        padding: 12,
                        cornerRadius: 8,
                    }
                },
                scales: {
                    x: {
                        grid: { color: 'rgba(255,255,255,0.04)' },
                        ticks: { color: '#666', font: { size: 12 } },
                    },
                    y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(255,255,255,0.04)' },
                        ticks: { color: '#666', font: { size: 12 }, stepSize: 1 },
                    }
                }
            }
        });
    }

    function renderTopAnswersChart(topAnswers) {
        var ctx = document.getElementById('topAnswersChart').getContext('2d');
        if (topAnswersChartInstance) topAnswersChartInstance.destroy();

        if (!topAnswers || topAnswers.length === 0) {
            ctx.canvas.parentElement.innerHTML = '<div style="text-align:center;color:#555;padding:40px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
            return;
        }

        var labels = topAnswers.map(function(a) {
            return a.label.length > 20 ? a.label.substring(0, 17) + '‚Ä¶' : a.label;
        });
        var values = topAnswers.map(function(a) { return a.count; });

        var colors = [
            '#00ff80','#00e673','#00cc66','#00b359','#00994d',
            '#4dabf7','#339af0','#228be6','#1c7ed6','#1971c2'
        ];

        topAnswersChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ',
                    data: values,
                    backgroundColor: colors.slice(0, values.length),
                    borderRadius: 6,
                    borderSkipped: false,
                    barThickness: 40,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: '#1a1a1a',
                        titleColor: '#fff',
                        bodyColor: '#00ff80',
                        borderColor: '#333',
                        borderWidth: 1,
                        padding: 12,
                        cornerRadius: 8,
                        callbacks: {
                            title: function(ctx) {
                                return topAnswers[ctx[0].dataIndex].label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(255,255,255,0.04)' },
                        ticks: { color: '#666', font: { size: 11 }, stepSize: 1 },
                    },
                    x: {
                        grid: { display: false },
                        ticks: { 
                            color: '#aaa', 
                            font: { size: 11 }, 
                            padding: 8,
                            maxRotation: 45,
                            minRotation: 0
                        },
                    }
                }
            }
        });
    }

    function renderAllAnswersTable(allAnswers) {
        var tbody = document.getElementById('allAnswersBody');
        if (!allAnswers || allAnswers.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" style="color:#555;text-align:center;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
            return;
        }
        var maxCount = allAnswers[0].count;
        tbody.innerHTML = allAnswers.map(function(a, i) {
            var pct = Math.round((a.count / maxCount) * 100);
            return '<tr>' +
                '<td style="color:#555;width:40px;">' + (i+1) + '</td>' +
                '<td>' + escapeHtml(a.label) + '</td>' +
                '<td style="color:#00ff80;font-weight:600;width:60px;text-align:right;">' + a.count + '</td>' +
                '<td class="bar-cell"><div class="mini-bar" style="width:'+pct+'%;"></div></td>' +
                '</tr>';
        }).join('');
    }

    function escapeHtml(text) {
        var d = document.createElement('div');
        d.appendChild(document.createTextNode(text));
        return d.innerHTML;
    }

    function toggleAllAnswers() {
        var table = document.getElementById('allAnswersTable');
        var btn = document.getElementById('btnExpandAnswers');
        table.classList.toggle('open');
        btn.innerHTML = table.classList.contains('open')
            ? '<i class="fa-solid fa-compress"></i> –°–≤–µ—Ä–Ω—É—Ç—å'
            : '<i class="fa-solid fa-expand"></i> –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –æ—Ç–≤–µ—Ç—ã';
    }

    function renderFunnel(funnelData) {
        var list = document.getElementById('funnelList');
        if (!funnelData || funnelData.length === 0) {
            list.innerHTML = '<li class="funnel-item" style="color:#555;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</li>';
            return;
        }
        var maxCount = funnelData[0].count;
        list.innerHTML = funnelData.map(function(item) {
            var pct = Math.round((item.count / maxCount) * 100);
            var label = item.label.length > 45 ? item.label.substring(0, 42) + '‚Ä¶' : item.label;
            return '<li class="funnel-item" title="' + escapeHtml(item.label) + '">' +
                '<span class="funnel-label">' + escapeHtml(label) + '</span>' +
                '<div class="funnel-bar-wrap"><div class="funnel-bar" style="width:'+pct+'%"></div></div>' +
                '<span class="funnel-count">' + item.count + '</span>' +
                '</li>';
        }).join('');
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Init Flatpickr with restrictions
        const fpFrom = flatpickr("#dateFrom", {
            locale: "ru",
            dateFormat: "Y-m-d",
            theme: "dark",
            maxDate: "today"
        });
        const fpTo = flatpickr("#dateTo", {
            locale: "ru",
            dateFormat: "Y-m-d",
            theme: "dark",
            maxDate: "today"
        });

        // Pre-fill from URL params
        const params = new URLSearchParams(window.location.search);
        if (params.get('date_from')) fpFrom.setDate(params.get('date_from'));
        if (params.get('date_to')) fpTo.setDate(params.get('date_to'));

        // "Default" button logic (Last 7 days)
        document.getElementById('btnReset').addEventListener('click', function() {
            const end = new Date();
            const start = new Date();
            start.setDate(end.getDate() - 7);

            fpFrom.setDate(start);
            fpTo.setDate(end);
            
             // Use Flatpickr's formatting to get correct string strings
            const fromStr = fpFrom.formatDate(start, "Y-m-d");
            const toStr = fpTo.formatDate(end, "Y-m-d");

            // Redirect to reload data
            window.location.href = '/admin/analytics?date_from=' + fromStr + '&date_to=' + toStr;
        });

        loadDashboard();
    });
</script>

<!-- Flatpickr -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://npmcdn.com/flatpickr/dist/l10n/ru.js"></script>

{% endblock %}