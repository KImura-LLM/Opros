# üè• –û–ø—Ä–æ—Å–Ω–∏–∫ –ø–∞—Ü–∏–µ–Ω—Ç–∞ ‚Äî PWA –¥–ª—è –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Å–±–æ—Ä–∞ –∞–Ω–∞–º–Ω–µ–∑–∞

–í–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–±–æ—Ä–∞ –∂–∞–ª–æ–± –∏ –∞–Ω–∞–º–Ω–µ–∑–∞ –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤ –ø–µ—Ä–µ–¥ –ø—Ä–∏—ë–º–æ–º –≤—Ä–∞—á–∞. –†–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ PWA (Progressive Web App), –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è —Å CRM –ë–∏—Ç—Ä–∏–∫—Å24. –î–æ—Å—Ç—É–ø ‚Äî –ø–æ –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ–π JWT-—Å—Å—ã–ª–∫–µ.

> üìö –í—Å—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –¥–µ–ø–ª–æ—é –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è–º —Ö—Ä–∞–Ω–∏—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ –æ—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è (–º–µ–Ω–µ–¥–∂–µ—Ä –ø–∞—Ä–æ–ª–µ–π / –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è Wiki).

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

```bash
# –ö–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –∏ —Å–æ–∑–¥–∞—Ç—å .env (–ø–æ –æ–±—Ä–∞–∑—Ü—É –Ω–∏–∂–µ)
cp .env.example .env

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤ dev-—Ä–µ–∂–∏–º–µ
docker compose up -d

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤ prod-—Ä–µ–∂–∏–º–µ
docker compose -f docker-compose.prod.yml up -d
```

| –°–µ—Ä–≤–∏—Å | URL |
|---|---|
| –§—Ä–æ–Ω—Ç–µ–Ω–¥ (Vite dev) | http://localhost:5173 |
| Backend API | http://localhost:8000/api/v1 |
| Swagger / OpenAPI | http://localhost:8000/docs |
| –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å | http://localhost:8000/admin |

---

## üèó –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
nginx (reverse proxy + SSL / Let's Encrypt)
    ‚îú‚îÄ‚îÄ frontend  (React 18 + Vite, :5173)
    ‚îî‚îÄ‚îÄ backend   (FastAPI + Uvicorn, :8000)
            ‚îú‚îÄ‚îÄ PostgreSQL 15  (–æ—Å–Ω–æ–≤–Ω–∞—è –ë–î)
            ‚îî‚îÄ‚îÄ Redis 7        (—Å–µ—Å—Å–∏–∏ / –∫—ç—à)
```

### –°–µ—Ä–≤–∏—Å—ã Docker Compose

| –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä | –û–±—Ä–∞–∑ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|---|---|---|
| `opros-nginx` | nginx:alpine | –†–µ–≤–µ—Ä—Å-–ø—Ä–æ–∫—Å–∏, SSL-—Ç–µ—Ä–º–∏–Ω–∞—Ü–∏—è |
| `opros-certbot` | certbot/certbot | –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ TLS-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ |
| `opros-backend` | custom (Python) | FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ |
| `opros-frontend` | custom (Node) | React / Vite |
| `opros-postgres` | postgres:15-alpine | –û—Å–Ω–æ–≤–Ω–∞—è –ë–î |
| `opros-redis` | redis:7-alpine | –°–µ—Å—Å–∏–∏ –∏ –∫—ç—à |

---

## üíª –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

### Backend
| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –í–µ—Ä—Å–∏—è | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|---|---|---|
| Python | 3.10+ | –Ø–∑—ã–∫ |
| FastAPI | 0.109 | ASGI-—Ñ—Ä–µ–π–º–≤–æ—Ä–∫ |
| Pydantic v2 | 2.5 | –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö |
| SQLAlchemy (async) | 2.0 | ORM |
| asyncpg | 0.29 | –î—Ä–∞–π–≤–µ—Ä PostgreSQL |
| Alembic | 1.13 | –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î |
| Redis-py | 5.0 | –ö–ª–∏–µ–Ω—Ç Redis |
| python-jose | 3.3 | JWT |
| WeasyPrint | 59 | –ì–µ–Ω–µ—Ä–∞—Ü–∏—è PDF |
| SQLAdmin | 0.16 | –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å |
| Loguru | 0.7 | –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ |
| Gunicorn | 21.2 | Production-—Å–µ—Ä–≤–µ—Ä |

### Frontend
| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –í–µ—Ä—Å–∏—è | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|---|---|---|
| React | 18.2 | UI-—Ñ—Ä–µ–π–º–≤–æ—Ä–∫ |
| TypeScript | 5.3 | –°—Ç—Ä–æ–≥–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è |
| Vite | 5.0 | –°–±–æ—Ä–∫–∞ / HMR |
| React Router | v6 | –†–æ—É—Ç–∏–Ω–≥ |
| Zustand | 4.4 | –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º |
| Tailwind CSS | 3.4 | –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è (Mobile First) |
| Framer Motion | 10 | –ê–Ω–∏–º–∞—Ü–∏–∏ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ |
| @xyflow/react | 12 | –í–∏–∑—É–∞–ª—å–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä –≥—Ä–∞—Ñ–∞ |
| vite-plugin-pwa | 0.17 | PWA / Service Worker |
| lucide-react | 0.303 | –ò–∫–æ–Ω–∫–∏ |

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
‚îú‚îÄ‚îÄ backend/
‚îÇ   ‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ api/v1/endpoints/     # –†–æ—É—Ç–µ—Ä—ã API
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.py           # –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (JWT)
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ survey.py         # –ü—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ –æ–ø—Ä–æ—Å–∞
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ survey_editor.py  # CRUD —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ reports.py        # –û—Ç—á—ë—Ç—ã (HTML/PDF/TXT)
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ analytics.py      # –î–∞—à–±–æ—Ä–¥ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ bitrix_webhook.py # –í—Ö–æ–¥—è—â–∏–µ –≤–µ–±—Ö—É–∫–∏ –ë24
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ survey_engine.py      # –î–≤–∏–∂–æ–∫ –æ–ø—Ä–æ—Å–Ω–∏–∫–∞
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ report_generator.py   # –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –æ—Ç—á—ë—Ç–æ–≤
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ bitrix24.py           # HTTP-–∫–ª–∏–µ–Ω—Ç –ë–∏—Ç—Ä–∏–∫—Å24
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ telegram_notifier.py  # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ url_shortener.py      # –°–æ–∫—Ä–∞—â–µ–Ω–∏–µ URL (bit.ly / clck.ru)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models/models.py      # SQLAlchemy-–º–æ–¥–µ–ª–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ schemas/schemas.py    # Pydantic-—Å—Ö–µ–º—ã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ core/                 # config, database, redis, middleware
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ admin/                # SQLAdmin (setup.py + HTML-—à–∞–±–ª–æ–Ω—ã)
‚îÇ   ‚îú‚îÄ‚îÄ data/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ survey_structure.json    # –û–ø—Ä–æ—Å–Ω–∏–∫ v1
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ survey_structure_v2.json # –û–ø—Ä–æ—Å–Ω–∏–∫ v2 (—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π)
‚îÇ   ‚îú‚îÄ‚îÄ alembic/versions/         # –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î
‚îÇ   ‚îî‚îÄ‚îÄ scripts/                  # –£—Ç–∏–ª–∏—Ç—ã (seed, cleanup, expire)
‚îÇ
‚îî‚îÄ‚îÄ frontend/
    ‚îî‚îÄ‚îÄ src/
        ‚îú‚îÄ‚îÄ pages/           # HomePage, SurveyPage, CompletePage, ErrorPage, EditorPage
        ‚îú‚îÄ‚îÄ components/
        ‚îÇ   ‚îú‚îÄ‚îÄ inputs/      # SingleChoice, MultiChoice, PainScale, BodyMap, TextInput
        ‚îÇ   ‚îî‚îÄ‚îÄ layout/      # Layout, AuthModal, Branding, SessionTimer
        ‚îú‚îÄ‚îÄ editor/          # –í–∏–∑—É–∞–ª—å–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä –æ–ø—Ä–æ—Å–Ω–∏–∫–∞ (@xyflow)
        ‚îú‚îÄ‚îÄ store/           # Zustand (surveyStore.ts)
        ‚îú‚îÄ‚îÄ api/             # HTTP-–∫–ª–∏–µ–Ω—Ç (surveyApi.ts)
        ‚îî‚îÄ‚îÄ types/           # TypeScript-—Ç–∏–ø—ã
```

---

## üîå API Endpoints (`/api/v1`)

| –ú–µ—Ç–æ–¥ | –ü—É—Ç—å | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|---|---|---|
| `POST` | `/auth/validate` | –í–∞–ª–∏–¥–∞—Ü–∏—è JWT-—Ç–æ–∫–µ–Ω–∞, —Å–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏ |
| `POST` | `/auth/consent` | –§–∏–∫—Å–∞—Ü–∏—è —Å–æ–≥–ª–∞—Å–∏—è –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ü–î–Ω |
| `GET` | `/survey/node/{id}` | –ü–æ–ª—É—á–∏—Ç—å —É–∑–µ–ª –æ–ø—Ä–æ—Å–Ω–∏–∫–∞ |
| `POST` | `/survey/answer` | –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç–≤–µ—Ç, –ø–æ–ª—É—á–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–π —É–∑–µ–ª |
| `POST` | `/survey/complete` | –ó–∞–≤–µ—Ä—à–∏—Ç—å –æ–ø—Ä–æ—Å, –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –ë24 |
| `GET` | `/editor/surveys` | –°–ø–∏—Å–æ–∫ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π –æ–ø—Ä–æ—Å–Ω–∏–∫–æ–≤ |
| `PUT` | `/editor/surveys/{id}` | –û–±–Ω–æ–≤–∏—Ç—å JSON-–∫–æ–Ω—Ñ–∏–≥ |
| `GET` | `/reports/{session_id}` | HTML-–ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –æ—Ç—á—ë—Ç–∞ |
| `GET` | `/reports/{session_id}/pdf` | –°–∫–∞—á–∞—Ç—å PDF-–æ—Ç—á—ë—Ç |
| `GET` | `/reports/{session_id}/txt` | –°–∫–∞—á–∞—Ç—å TXT-–æ—Ç—á—ë—Ç |
| `GET` | `/analytics/dashboard` | –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è –¥–∞—à–±–æ—Ä–¥–∞ |
| `POST` | `/bitrix/webhook` | –í—Ö–æ–¥—è—â–∏–π –≤–µ–±—Ö—É–∫ –æ—Ç –ë–∏—Ç—Ä–∏–∫—Å24 |

---

## üóÑ –ú–æ–¥–µ–ª–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

| –¢–∞–±–ª–∏—Ü–∞ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|---|---|
| `survey_configs` | JSON-–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –æ–ø—Ä–æ—Å–Ω–∏–∫–æ–≤ (–º—É–ª—å—Ç–∏–≤–µ—Ä—Å–∏–æ–Ω–Ω–æ—Å—Ç—å) |
| `survey_sessions` | –°–µ—Å—Å–∏–∏ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è (–ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ `lead_id` –ë24) |
| `survey_answers` | –û—Ç–≤–µ—Ç—ã –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã (JSONB, –ø–æ `node_id`) |
| `audit_logs` | –ñ—É—Ä–Ω–∞–ª –∞—É–¥–∏—Ç–∞ (—Ö—Ä–∞–Ω–∏—Ç—Å—è ‚â§ 24 —á –ø–æ 152-–§–ó) |

---

## üß† –î–≤–∏–∂–æ–∫ –æ–ø—Ä–æ—Å–Ω–∏–∫–∞ (Survey Engine)

–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Ä–µ–Ω–¥–µ—Ä–∏—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ JSON-–≥—Ä–∞—Ñ–∞. –õ–æ–≥–∏–∫–∞ **–Ω–µ —Ö–∞—Ä–¥–∫–æ–¥–∏—Ç—Å—è –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö**.

### –¢–∏–ø—ã —É–∑–ª–æ–≤ (`type`)
| –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|---|---|
| `single_choice` | –û–¥–∏–Ω –≤–∞—Ä–∏–∞–Ω—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ (–∫–∞—Ä—Ç–æ—á–∫–∏) |
| `multi_choice` | –ù–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ |
| `scale_1_10` | –®–∫–∞–ª–∞ –±–æ–ª–∏ |
| `body_map` | –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è —Å—Ö–µ–º–∞ —Ç–µ–ª–∞ |
| `text_input` | –°–≤–æ–±–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –≤–≤–æ–¥ |
| `info_screen` | –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π —ç–∫—Ä–∞–Ω |

### –í–µ—Ä—Å–∏–∏ –æ–ø—Ä–æ—Å–Ω–∏–∫–∞
- **v1** ‚Äî –±–∞–∑–æ–≤—ã–π (`survey_structure.json`)
- **v2** ‚Äî —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π, –≤–∫–ª—é—á–∞–µ—Ç `body_location`, `pain_character`, —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ —Å–∏—Å—Ç–µ–º–∞–º (`resp_filter`, `cardio_filter`, `gastro_filter` –∏ –¥—Ä.)

–í–µ—Ä—Å–∏—è –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ –Ω–∞–ª–∏—á–∏—é —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö —É–∑–ª–æ–≤.

---

## üìä –û—Ç—á—ë—Ç—ã –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞

- **HTML-–æ—Ç—á—ë—Ç** ‚Äî —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π, –≥–æ—Ç–æ–≤ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –≤ –ë–∏—Ç—Ä–∏–∫—Å24 (–º–µ—Ç–æ–¥ `crm.timeline.comment.add`)
- **PDF-–æ—Ç—á—ë—Ç** ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ WeasyPrint, –ø—Ä–∏–≥–æ–¥–µ–Ω –¥–ª—è –ø–µ—á–∞—Ç–∏
- **TXT-–æ—Ç—á—ë—Ç** ‚Äî —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
- **–î–∞—à–±–æ—Ä–¥ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏** ‚Äî –¥–∏–Ω–∞–º–∏–∫–∞ –æ–ø—Ä–æ—Å–æ–≤ –ø–æ –¥–Ω—è–º, —Ç–æ–ø –æ—Ç–≤–µ—Ç–æ–≤, –≤–æ—Ä–æ–Ω–∫–∞ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è, —Å—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ 152-–§–ó

| –ú–µ—Ö–∞–Ω–∏–∑–º | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è |
|---|---|
| **JWT Auth** | –û–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–µ —Ç–æ–∫–µ–Ω—ã (`?token=...`), —Ö—ç—à —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –ë–î |
| **Rate Limiting** | `RateLimitMiddleware` (FastAPI) + Nginx |
| **CORS** | –°—Ç—Ä–æ–≥–∏–π —Å–ø–∏—Å–æ–∫ `CORS_ORIGINS` –∏–∑ `.env` |
| **–°–æ–≥–ª–∞—Å–∏–µ –ü–î–Ω** | –ë–ª–æ–∫–∏—Ä—É—é—â–∏–π —ç–∫—Ä–∞–Ω, `consent_given` —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è –≤ –ë–î |
| **–û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö** | `AuditLog` ‚Äî TTL 24 —á, `scripts/cleanup.py` |
| **–ê–≤—Ç–æ-–∏—Å—Ç–µ—á–µ–Ω–∏–µ —Å–µ—Å—Å–∏–π** | –§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ + `scripts/auto_expire_sessions.py` |
| **–ù–µ—Ç PII –≤ localStorage** | –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–æ–ª—å–∫–æ –≤ RAM (Zustand) –∏ Redis |
| **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ–∫—Ä–µ—Ç–æ–≤** | –ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è `SECRET_KEY`, `JWT_SECRET_KEY`, `ADMIN_PASSWORD` |

---

## üì° –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### –ë–∏—Ç—Ä–∏–∫—Å24
- **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è:** JWT-—Å—Å—ã–ª–∫–∞ `?token=<JWT>` —Å `lead_id` –∏ `entity_type` (DEAL / LEAD)
- **–û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:** `crm.timeline.comment.add` (HTML-–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ –ª–µ–Ω—Ç—É)
- **–ó–∞–≥—Ä—É–∑–∫–∞ PDF:** —á–µ—Ä–µ–∑ –¥–∏—Å–∫ –ë–∏—Ç—Ä–∏–∫—Å24, –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏–µ –∫ —Å–¥–µ–ª–∫–µ
- **–í—Ö–æ–¥—è—â–∏–π –≤–µ–±—Ö—É–∫:** `/api/v1/bitrix/webhook` ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π –æ—Ç –ë24
- **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –≤–æ—Ä–æ–Ω–æ–∫:** `BITRIX24_ALLOWED_CATEGORIES` (—Å–ø–∏—Å–æ–∫ ID —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)

### Telegram
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–∞—Ü–∏–µ–Ω—Ç–∞–º —á–µ—Ä–µ–∑ Telegram Bot API (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞: `TELEGRAM_BOT_TOKEN` –≤ `.env`

### –°–æ–∫—Ä–∞—â–µ–Ω–∏–µ URL
- –ü—Ä–æ–≤–∞–π–¥–µ—Ä—ã: **clck.ru** (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –±–µ—Å–ø–ª–∞—Ç–Ω–æ) –∏–ª–∏ **Bit.ly** (—Ç–æ–∫–µ–Ω `BITLY_ACCESS_TOKEN`)
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å—Å—ã–ª–æ–∫ –Ω–∞ –æ–ø—Ä–æ—Å–Ω–∏–∫ –≤ SMS

---

## ‚öôÔ∏è –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (`.env`)

```dotenv
# –û–±—â–∏–µ
ENVIRONMENT=production
DEBUG=false
SECRET_KEY=–∑–∞–º–µ–Ω–∏—Ç–µ-–Ω–∞-—Å–ª—É—á–∞–π–Ω—É—é-—Å—Ç—Ä–æ–∫—É
FRONTEND_URL=https://your-domain.com

# PostgreSQL
POSTGRES_USER=opros_user
POSTGRES_PASSWORD=–Ω–∞–¥—ë–∂–Ω—ã–π-–ø–∞—Ä–æ–ª—å
POSTGRES_DB=opros_db
POSTGRES_HOST=postgres

# Redis
REDIS_HOST=redis
REDIS_PASSWORD=–Ω–∞–¥—ë–∂–Ω—ã–π-–ø–∞—Ä–æ–ª—å-redis

# JWT
JWT_SECRET_KEY=–∑–∞–º–µ–Ω–∏—Ç–µ-–Ω–∞-—Å–ª—É—á–∞–π–Ω—É—é-—Å—Ç—Ä–æ–∫—É
JWT_EXPIRATION_HOURS=48

# –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
ADMIN_USERNAME=admin
ADMIN_PASSWORD=–Ω–∞–¥—ë–∂–Ω—ã–π-–ø–∞—Ä–æ–ª—å

# –ë–∏—Ç—Ä–∏–∫—Å24
BITRIX24_WEBHOOK_URL=https://your-bitrix.bitrix24.ru/rest/...
BITRIX24_INCOMING_TOKEN=—Ç–æ–∫–µ–Ω-–≤—Ö–æ–¥—è—â–µ–≥–æ-–≤–µ–±—Ö—É–∫–∞
BITRIX24_ALLOWED_CATEGORIES=19,25   # –ü—É—Å—Ç–æ = –≤—Å–µ –≤–æ—Ä–æ–Ω–∫–∏

# –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
TELEGRAM_BOT_TOKEN=
BITLY_ACCESS_TOKEN=
URL_SHORTENER_PROVIDER=clckru       # bitly | clckru
RATE_LIMIT_PER_MINUTE=60
CORS_ORIGINS_STR=https://your-domain.com
```

---

## üóÉ –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î

```bash
# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
docker compose exec backend alembic upgrade head

# –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –º–∏–≥—Ä–∞—Ü–∏—é
docker compose exec backend alembic revision --autogenerate -m "–æ–ø–∏—Å–∞–Ω–∏–µ"
```

---

## üõ† –°–∫—Ä–∏–ø—Ç—ã –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è (`backend/scripts/`)

| –°–∫—Ä–∏–ø—Ç | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|---|---|
| `seed.py` | –ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—á–∞–ª—å–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –æ–ø—Ä–æ—Å–Ω–∏–∫–∞ –≤ –ë–î |
| `cleanup.py` | –û—á–∏—Å—Ç–∏—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ audit-–ª–æ–≥–∏ (152-–§–ó) |
| `auto_expire_sessions.py` | –ü–µ—Ä–µ–≤–µ—Å—Ç–∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏ –≤ `abandoned` |
| `test_notifications.py` | –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π |
| `test_session_expiry.py` | –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏–∫—É –∏—Å—Ç–µ—á–µ–Ω–∏—è —Å–µ—Å—Å–∏–π |

---

