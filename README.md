# Техническое задание на разработку PWA-приложения "Опросник пациента"

**Роль:** Senior Fullstack Developer / System Architect  
**Задача:** Спроектировать и разработать архитектуру веб-приложения для предварительного сбора анамнеза пациентов.  
**Контекст:** Приложение работает как независимое SPA (Single Page Application) с возможностью установки как PWA. Данные передаются в CRM Битрикс24.

---

## 1. Технический стек (Tech Stack)

Выбранный стек должен обеспечивать высокую производительность (Google Lighthouse > 90), безопасность медицинских данных и кроссплатформенность.

### 1.1 Frontend (Client Side)
- **Framework:** React 18+. Использовать функциональные компоненты и Hooks.
- **Build Tool:** Vite. Для минимизации времени сборки и HMR (Hot Module Replacement).
- **Language:** TypeScript. Строгая типизация обязательна для всех интерфейсов данных (особенно JSON-структуры опросника).
- **Routing:** React Router v6. Поддержка query-params для чтения токенов авторизации.
- **State Management:** Zustand или Redux Toolkit. Для хранения сессии пользователя, прогресса прохождения и кэширования ответов.
- **UI/Styling:** Tailwind CSS. Использование utility-first классов для быстрой адаптивной верстки (Mobile First подход).
- **Animations:** Framer Motion. Для плавных переходов между экранами (Page Transitions) и анимации элементов интерфейса (Micro-interactions).
- **PWA:** vite-plugin-pwa. Настройка manifest.json и Service Workers для оффлайн-доступа (кэширование статики).

### 1.2 Backend (Server Side)
- **Language/Framework:** Python 3.10+ / FastAPI. Асинхронная архитектура (ASGI), автоматическая генерация документации (Swagger/OpenAPI).
- **Data Validation:** Pydantic. Строгая валидация входящих и исходящих данных.
- **ORM:** SQLAlchemy (Async) или Tortoise ORM.
- **Server:** Uvicorn (запуск за прокси Nginx).

### 1.3 Database & Storage
- **Primary DB:** PostgreSQL. Хранение: пользователи, логи событий, структура опросников, результаты.
- **Cache/Session:** Redis. Хранение временных сессий, прогресса прохождения (TTL сессии = времени жизни токена), rate limiting.

---

## 2. Архитектура и Логика опроса (Survey Engine)

Система должна быть реализована как движок, рендерящий интерфейс на основе входящего JSON-конфига.

### 2.1 Структура JSON-сценария (Data Model)
Опросник не хардкодится в верстке. Frontend получает JSON-структуру, содержащую граф вопросов.

- **Node (Узел):** Единица опроса (экран).
- **id:** Уникальный идентификатор вопроса.
- **type:** Тип рендера (`single_choice`, `multi_choice`, `scale_1_10`, `body_map`, `text_input`, `info_screen`).
- **question_text:** Текст вопроса.
- **options:** Массив вариантов ответа (для choice-типов).
- **logic:** Правила перехода. Пример: `if answer == "option_A" goto "node_5" else goto "node_6"`.
- **required:** Булево значение (обязательность ответа).

### 2.2 Логика навигации
- **Linear & Branching:** Поддержка как линейных переходов, так и условного ветвления (Branching Logic) на основе предыдущих ответов.
- **History Stack:** Реализация стека переходов для корректной работы кнопки "Назад" при сложной нелинейной структуре.
- **Auto-save:** При переходе к следующему узлу ответ асинхронно отправляется в Redis (сохранение стейта).

---

## 3. Визуальный дизайн и UX (Design System)

Интерфейс должен минимизировать когнитивную нагрузку и вызывать доверие.

### 3.1 Layout (Макет)
- **One Screen — One Question:** На экране всегда только один активный вопрос.
- **Header:** Логотип клиники (слева), Кнопка "Закрыть/Выход" (справа).
- **Progress Bar:** Линейный индикатор сверху. Должен отражать реальный или "виртуальный" прогресс (чтобы не демотивировать пользователя при длинных ветках). Анимация заполнения плавная.
- **Footer:** Кнопки навигации ("Назад" — второстепенная, "Далее" — основная/CTA). Кнопка "Далее" может быть disabled до выбора ответа.

### 3.2 UI Components
- **Cards:** Варианты ответов оформлены как крупные карточки (Card UI) с высокой областью клика (min-height: 48px).
- **Typography:** Крупные заголовки (Sans-serif), высокий контраст для читаемости (WCAG AA compliant).
- **Input Controls:** Использование нативных элементов ввода мобильных устройств (клавиатура numeric для ввода цифр и т.д.).

### 3.3 Анимации (Micro-interactions)
- **Slide Transitions:** При нажатии "Далее" текущий экран уходит влево (opacity 1 -> 0, x -> -100%), новый появляется справа. При "Назад" — инверсия.
- **Selection Feedback:** Визуальный отклик при тапе на вариант ответа (scale 0.98 -> 1.0, изменение цвета бордера/фона).

---

## 4. Интеграция с Битрикс24 (Integration Layer)

Взаимодействие осуществляется через REST API и Webhooks. Система не хранит персональные данные в открытом виде дольше сессии.

### 4.1 Авторизация (Token-based Auth)
- **Вход:** Ссылка вида `https://app.domain.com/?token={JWT}`.
- **JWT Payload:** Содержит зашифрованные lead_id (ID сделки/лида), patient_id (если есть), expiration_timestamp (срок жизни ссылки).
- **Validation:** Middleware на Backend проверяет подпись токена и срок действия. При ошибке возвращает статус 401/403 и экран "Ссылка недействительна".

### 4.2 Передача данных (Data Flow)
1. **Start:** При инициализации (валидации токена) Frontend запрашивает у Backend персонализацию (Имя пациента) для приветствия.
2. **Finish:** По завершении опроса Backend:
   - Генерирует человекочитаемый отчет (PDF или Markdown-текст).
   - Отправляет данные в Битрикс24 через входящий вебхук (метод `crm.lead.update` или `crm.timeline.comment.add`).
   - Помечает токен как использованный (invalidate).

---

## 5. Безопасность и Compliance (Security)

Соблюдение требований 152-ФЗ и GDPR.

### 5.1 Обработка данных
- **Consent Screen:** Первый экран — строго блокирующий интерфейс с текстом согласия на обработку ПДн и чекбоксом. Без акцепта переход дальше невозможен.
- **Data Minimization:** В базе данных приложения не хранятся ФИО в привязке к медицинским данным в долгосрочной перспективе (очистка логов каждые 24 часа). Связка идет только через ID из CRM.

### 5.2 Сетевая безопасность
- **HTTPS/TLS 1.3:** Весь трафик шифруется.
- **CORS:** Строгая политика Cross-Origin Resource Sharing. Разрешены запросы только с доверенного домена фронтенда.
- **Rate Limiting:** Защита API от DDOS и перебора токенов (Throttling на уровне Nginx или FastAPI Middleware).
- **Sanitization:** Очистка всех входящих текстовых данных от скриптов (XSS protection).

---

> **Инструкция для разработчика:** Используй данное ТЗ как архитектурный план. Реализацию начинать с настройки Backend (FastAPI + Pydantic models для структуры вопроса), затем Frontend (React + логика рендера JSON). Сценарий вопросов будет предоставлен отдельным JSON-файлом.
